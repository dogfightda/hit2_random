<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì¥ê¸¸ë“œ ëœë¤ ë½‘ê¸°</title>
    <!-- Tailwind CSS CDN + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: #23272b;
            color: #f8f9fa;
            font-family: 'Pretendard', sans-serif;
        }
        .modal-bg {
            background: rgba(40, 44, 52, 0.85);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pop {
            0% { transform: scale(0.7); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .bg-base-100, .card, .modal-bg, .table {
            background: #343a40 !important;
            color: #f8f9fa !important;
        }
        .bg-base-200 {
            background: #23272b !important;
        }
        .rounded-2xl {
            border-radius: 1rem;
        }
        .shadow-xl {
            box-shadow: 0 4px 24px rgba(0,0,0,0.25);
        }
        .input, .input-bordered {
            background: #495057;
            color: #f8f9fa;
            border: 1px solid #6c757d;
            box-shadow: none;
        }
        .input:focus {
            border-color: #3366ff;
            outline: none;
            background: #495057;
            color: #fff;
        }
        .btn {
            border: none;
            border-radius: 0.3rem;
            font-weight: 600;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }
        .btn-primary {
            background: #3366ff;
            color: #fff;
        }
        .btn-primary:hover {
            background: #254eda;
            color: #fff;
        }
        .btn-success {
            background: #28a745;
            color: #fff;
        }
        .btn-success:hover {
            background: #218838;
            color: #fff;
        }
        .btn-error, .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        .btn-error:hover, .btn-danger:hover {
            background: #c0392b;
            color: #fff;
        }
        .btn-warning {
            background: #ff9800;
            color: #fff;
        }
        .btn-warning:hover {
            background: #e68900;
            color: #fff;
        }
        .btn-secondary, .btn-ghost {
            background: #6c757d;
            color: #fff;
        }
        .btn-secondary:hover, .btn-ghost:hover {
            background: #565e64;
            color: #fff;
        }
        .text-primary {
            color: #f8f9fa !important;
        }
        .text-base-content {
            color: #dee2e6 !important;
        }
        .hover\:bg-base-200:hover {
            background: #23272b !important;
        }
        .table th {
            background: #23272b !important;
            color: #f8f9fa !important;
        }
        .table tr:hover {
            background: #495057 !important;
        }
        .badge.bg-success {
            background: #28a745 !important;
            color: #fff !important;
        }
    </style>
</head>
<body data-theme="dark" class="bg-base-200 min-h-screen">
    <div class="max-w-3xl mx-auto py-4 px-4">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-primary tracking-tight">ëŒ€ì¥ê¸¸ë“œ ëœë¤ ë½‘ê¸°</h1>
            <div>
                <button id="adminButton" class="btn btn-outline-primary" onclick="setAdmin()">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
                <span id="authInfo" style="display:none;">
                    <span class="badge bg-success text-black">ê´€ë¦¬ì ë¡œê·¸ì¸ë¨</span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </span>
            </div>
        </div>
        <div class="flex flex-col md:flex-row gap-6 mb-8">
            <!-- ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡ -->
            <div class="flex-1 bg-base-100 rounded-2xl shadow-xl p-5 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-lg font-semibold text-base-content">ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡</span>
                    <button class="btn btn-success btn-sm" onclick="addAllBaseIdsToDrawList()">ì „ì²´ì¶”ê°€</button>
                </div>
                <ul id="baseIdList" class="flex-1 overflow-y-auto scrollbar-hide"></ul>
            </div>
            <!-- ë½‘ê¸° ëŒ€ìƒ ëª©ë¡ -->
            <div class="flex-1 bg-base-100 rounded-2xl shadow-xl p-5 flex flex-col">
                <span class="text-lg font-semibold text-base-content mb-3">ë½‘ê¸° ëŒ€ìƒ ëª©ë¡</span>
                <ul id="drawIdList" class="flex-1 overflow-y-auto scrollbar-hide"></ul>
            </div>
        </div>
        <!-- ì¶”ì²¨ ì˜ì—­ -->
        <div class="bg-base-100 rounded-2xl shadow-xl p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center gap-3 mb-4">
                <input type="number" id="count" class="flex-1 input input-bordered text-lg" min="1" value="1" placeholder="ë½‘ì„ ì¸ì› ìˆ˜">
                <button class="btn btn-primary text-lg font-bold px-6" id="drawBtn">ì¶”ì²¨í•˜ê¸°</button>
            </div>
            <div id="result" class="min-h-[2.5rem] text-center text-base-content text-lg font-semibold py-2"></div>
        </div>
    </div>

    <!-- ì…ë ¥ ë‚´ì—­ í‘œì‹œ ì˜ì—­ -->
    <div class="max-w-3xl mx-auto py-4 px-4">
        <div class="bg-base-100 rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold mb-4 text-primary">ë¶„ë°° ë‚´ì—­</h2>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th class="text-center">ë‚ ì§œ</th>
                            <th class="text-center">ë‹‰ë„¤ì„</th>
                            <th class="text-center">ì•„ì´í…œ</th>
                            <th class="text-center" id="actionColumn" style="display: none;">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="adminInputList" class="text-center">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ë¶„ë°° ë‚´ì—­ ì…ë ¥ í¼ -->
    <div id="distributionInputForm" class="max-w-3xl mx-auto py-4 px-4" style="display: none;">
        <div class="bg-base-100 rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold mb-4 text-primary">ë¶„ë°° ë‚´ì—­ ì…ë ¥</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ë‚ ì§œ</span>
                    </label>
                    <input type="date" id="distributionDate" class="input input-bordered" style="appearance: none; -webkit-appearance: none;">
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ë‹‰ë„¤ì„</span>
                    </label>
                    <select id="distributionNickname" class="input input-bordered">
                        <option value="">ë‹‰ë„¤ì„ ì„ íƒ</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">ì•„ì´í…œ</span>
                    </label>
                    <input type="text" id="distributionItem" class="input input-bordered" placeholder="ì•„ì´í…œ ì…ë ¥">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button class="btn btn-primary" onclick="saveDistributionInput()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addIdModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg">
        <div class="bg-base-100 rounded-2xl shadow-2xl p-7 w-full max-w-xs mx-auto relative animate-fadeIn">
            <button class="absolute top-3 right-3 text-base-content hover:text-primary text-xl" onclick="closeAddIdModal()">&times;</button>
            <div class="text-lg font-bold mb-4 text-base-content">ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€</div>
            <input type="text" id="modalNewId" class="w-full input input-bordered text-base mb-4" placeholder="ìƒˆë¡œìš´ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="flex gap-2 justify-end">
                <button class="btn btn-ghost" onclick="closeAddIdModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="addNewIdFromModal()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAY6Ff6uZ-iZ7soeuXBU0mtTKKZZ8gAPck",
            authDomain: "bossraidtracker.firebaseapp.com",
            databaseURL: "https://bossraidtracker-default-rtdb.firebaseio.com",
            projectId: "bossraidtracker",
            storageBucket: "bossraidtracker.appspot.com",
            messagingSenderId: "975753692062",
            appId: "1:975753692062:web:0991fb5bcbc52a9d3d0c8f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡
        const defaultIds = [
            "ì±„ë¦¬ëŒ€ì¥", "ì´ê´„ëŒ€ì¥", "ê³°ë„ë¦¬ì ¤ë¦¬", "ìˆ˜ë‹¬ëŒ€ì¥", "ê°€ë“ ëŒ€ì¥",
            "ê·¸ëƒ¥ëŒ€ì¥", "ë‚´ì‚¬ë‘ì •í¬", "ë¦¬ìƒ¤ëŒ€ì¥", "í˜¸êµ¬ëŒ€ì¥", "ë½€ë¹ ì´ëŒ€ì¥",
            "ì§„ì§œëŒ€ì¥", "íŒë‹¤ëŒ€ì¥", "í­í¬ëŒ€ì¥", "í™”ê¸°ëŒ€ì¥", "ê¸°ë³¸ì›ì¹™ëŒì‡ ëŒ€ì¥",
            "ì­ˆë‹ˆëŒ€ì¥", "ìº‡ëšœëŒ€ì¥", "ì—´ì •ëŒ€ì¥", "ì˜ˆìŠ¤ëŒ€ì¥", "ì¸„í•˜ì´ëŒ€ì¥",
            "ë¹ ë£¨ëŒ€ì¥", "ì…ë”œëŒ€ì¥", "ê°€ì± ëŒ€ì¥", "ë‚´ê°€ëŒ€ì¥", "í–¥ê¸°ëŒ€ì¥"
        ];

        // ì „ì—­ í•¨ìˆ˜ë“¤
        window.initializeAndDisplayDefaultIds = async function() {
            const baseIdList = document.getElementById('baseIdList');
            const resultDiv = document.getElementById('result');
            try {
                const snapshot = await db.ref('randomDrawLists/defaultIds').once('value');
                let data = snapshot.val();
                if (!data) {
                    await db.ref('randomDrawLists/defaultIds').set({
                        name: 'ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡',
                        participants: defaultIds,
                        type: 'randomDraw',
                        createdAt: Date.now()
                    });
                    data = { participants: defaultIds };
                }
                baseIdList.innerHTML = '';
                (data.participants || []).sort().forEach((id) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between py-2 px-3 rounded-lg hover:bg-base-200 group transition';
                    const isAdmin = localStorage.getItem("admin") === "dogfightda@gmail.com";
                    li.innerHTML = `
                        <span class="text-base-content">${id}</span>
                        <div class="flex gap-2">
                            <button class="btn btn-success btn-xs" onclick="addToDrawList('${id}')">ì¶”ê°€</button>
                            ${isAdmin ? `<button class="btn btn-error btn-xs" onclick="removeBaseId('${id}')">ID ì‚­ì œ</button>` : ''}
                        </div>
                    `;
                    baseIdList.appendChild(li);
                });
                // [ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€] ë²„íŠ¼
                const isAdmin = localStorage.getItem("admin") === "dogfightda@gmail.com";
                if (isAdmin) {
                    const addBtnLi = document.createElement('li');
                    addBtnLi.className = 'py-2 px-3 text-center';
                    addBtnLi.innerHTML = `<button class="btn btn-primary btn-sm w-full" onclick="openAddIdModal()">+ ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€</button>`;
                    baseIdList.appendChild(addBtnLi);
                }
            } catch (error) {
                console.error('ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                resultDiv.textContent = 'ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ' + error.message;
                resultDiv.className = 'text-error text-center py-2';
            }
        };

        window.removeBaseId = async function(id) {
            if (!confirm('ì •ë§ë¡œ ì´ IDë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const snapshot = await db.ref('randomDrawLists/defaultIds').once('value');
                let data = snapshot.val();
                if (data && data.participants) {
                    data.participants = data.participants.filter(item => item !== id);
                    await db.ref('randomDrawLists/defaultIds').update({
                        participants: data.participants
                    });
                    await window.initializeAndDisplayDefaultIds();
                    await window.refreshDistributionNicknameOptions();
                }
            } catch (error) {
                console.error('ID ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ID ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        window.addToDrawList = function(id) {
            const drawIdList = document.getElementById('drawIdList');
            const current = Array.from(drawIdList.children).map(li => li.querySelector('span').textContent);
            if (current.includes(id)) return;
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between py-2 px-3 rounded-lg hover:bg-base-200 group transition';
            li.innerHTML = `
                <span class="text-base-content">${id}</span>
                <button class="btn btn-ghost btn-xs" onclick="removeDrawId(this)">ì œê±°</button>
            `;
            drawIdList.appendChild(li);
            // ì´ë¦„ìˆœ ì •ë ¬
            const items = Array.from(drawIdList.children);
            items.sort((a, b) => a.querySelector('span').textContent.localeCompare(b.querySelector('span').textContent));
            items.forEach(item => drawIdList.appendChild(item));
        };

        window.addAllBaseIdsToDrawList = async function() {
            const drawIdList = document.getElementById('drawIdList');
            try {
                const snapshot = await db.ref('randomDrawLists/defaultIds').once('value');
                let data = snapshot.val();
                if (data && data.participants) {
                    const current = Array.from(drawIdList.children).map(li => li.querySelector('span').textContent);
                    data.participants.forEach(id => {
                        if (!current.includes(id)) {
                            const li = document.createElement('li');
                            li.className = 'flex items-center justify-between py-2 px-3 rounded-lg hover:bg-base-200 group transition';
                            li.innerHTML = `
                                <span class="text-base-content">${id}</span>
                                <button class="btn btn-ghost btn-xs" onclick="removeDrawId(this)">ì œê±°</button>
                            `;
                            drawIdList.appendChild(li);
                        }
                    });
                    // ì´ë¦„ìˆœ ì •ë ¬
                    const items = Array.from(drawIdList.children);
                    items.sort((a, b) => a.querySelector('span').textContent.localeCompare(b.querySelector('span').textContent));
                    items.forEach(item => drawIdList.appendChild(item));
                }
            } catch (error) {
                console.error('ì „ì²´ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì „ì²´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ê´€ë¦¬ì ì„¤ì • í•¨ìˆ˜
        window.setAdmin = function() {
            const email = prompt("ê´€ë¦¬ì ì´ë©”ì¼:");
            const password = prompt("ë¹„ë°€ë²ˆí˜¸:");
            if (email === "dogfightda@gmail.com" && password === "0716") {
                localStorage.setItem("admin", email);
                alert("ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ!");
                checkAdmin();
                window.location.reload();
            } else {
                alert("ì¸ì¦ ì‹¤íŒ¨");
            }
        };

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        window.logout = function() {
            localStorage.removeItem("admin");
            alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
            checkAdmin();
            window.location.reload();
        };

        // ê´€ë¦¬ì ìƒíƒœ í™•ì¸
        function checkAdmin() {
            const adminButton = document.getElementById("adminButton");
            const authInfo = document.getElementById("authInfo");
            const distributionInputForm = document.getElementById("distributionInputForm");
            const isAdmin = localStorage.getItem("admin") === "dogfightda@gmail.com";
            adminButton.style.display = isAdmin ? "none" : "inline-block";
            authInfo.style.display = isAdmin ? "inline-block" : "none";
            distributionInputForm.style.display = isAdmin ? "block" : "none";
        }

        // ë¶„ë°° ë‚´ì—­ ì €ì¥
        window.saveDistributionInput = async function() {
            const date = document.getElementById('distributionDate').value;
            const nickname = document.getElementById('distributionNickname').value;
            const item = document.getElementById('distributionItem').value;

            if (!date || !nickname || !item) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                const newInput = {
                    date,
                    nickname,
                    item,
                    timestamp: Date.now()
                };

                await db.ref('randomDrawLists/distributionInputs').push(newInput);
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('distributionDate').value = '';
                document.getElementById('distributionNickname').value = '';
                document.getElementById('distributionItem').value = '';

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadDistributionInputs();
            } catch (error) {
                console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ë¶„ë°° ë‚´ì—­ ëª©ë¡ ë¡œë“œ
        window.loadDistributionInputs = async function() {
            const inputList = document.getElementById('adminInputList');
            const actionColumn = document.getElementById('actionColumn');
            const isAdmin = localStorage.getItem("admin") === "dogfightda@gmail.com";
            
            try {
                const snapshot = await db.ref('randomDrawLists/distributionInputs').once('value');
                const inputs = snapshot.val() || {};
                
                inputList.innerHTML = '';
                actionColumn.style.display = isAdmin ? 'table-cell' : 'none';
                
                Object.entries(inputs)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp)
                    .forEach(([key, data]) => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-base-200 transition-colors';
                        tr.innerHTML = `
                            <td class="font-medium">${data.date}</td>
                            <td>${data.nickname}</td>
                            <td>${data.item}</td>
                            ${isAdmin ? `
                                <td>
                                    <button class="btn btn-error btn-xs" onclick="deleteDistributionInput('${key}')">ì‚­ì œ</button>
                                </td>
                            ` : ''}
                        `;
                        inputList.appendChild(tr);
                    });

                if (Object.keys(inputs).length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="${isAdmin ? '4' : '3'}" class="text-center py-4 text-base-content/60">
                            ì…ë ¥ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    `;
                    inputList.appendChild(tr);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="${isAdmin ? '4' : '3'}" class="text-center py-4 text-error">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                    </td>
                `;
                inputList.appendChild(tr);
            }
        };

        // ë¶„ë°° ë‚´ì—­ ì‚­ì œ
        window.deleteDistributionInput = async function(key) {
            if (!confirm('ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.ref(`randomDrawLists/distributionInputs/${key}`).remove();
                await loadDistributionInputs();
            } catch (error) {
                console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
        window.openAddIdModal = function() {
            document.getElementById('addIdModal').classList.remove('hidden');
            document.getElementById('addIdModal').classList.add('flex');
            document.getElementById('modalNewId').focus();
        };
        // ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°
        window.closeAddIdModal = function() {
            document.getElementById('addIdModal').classList.add('hidden');
            document.getElementById('addIdModal').classList.remove('flex');
            document.getElementById('modalNewId').value = '';
        };

        // ë‹‰ë„¤ì„ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ê°±ì‹  í•¨ìˆ˜
        window.refreshDistributionNicknameOptions = async function() {
            const nicknameSelect = document.getElementById('distributionNickname');
            if (!nicknameSelect) return;
            nicknameSelect.innerHTML = '<option value="">ë‹‰ë„¤ì„ ì„ íƒ</option>';
            try {
                const snapshot = await db.ref('randomDrawLists/defaultIds').once('value');
                let data = snapshot.val();
                let ids = (data && data.participants) ? data.participants : window.defaultIds;
                ids.sort().forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = id;
                    nicknameSelect.appendChild(option);
                });
            } catch (e) {
                window.defaultIds.sort().forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = id;
                    nicknameSelect.appendChild(option);
                });
            }
        };

        // ì‹ ê·œ ì•„ì´ë”” ì¶”ê°€ í•¨ìˆ˜
        window.addNewIdFromModal = async function() {
            const input = document.getElementById('modalNewId');
            const newId = input.value.trim();
            if (!newId) {
                alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            try {
                // ê¸°ì¡´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                const snapshot = await db.ref('randomDrawLists/defaultIds').once('value');
                let data = snapshot.val();
                let ids = (data && data.participants) ? data.participants : window.defaultIds;
                if (ids.includes(newId)) {
                    alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
                    return;
                }
                ids.push(newId);
                await db.ref('randomDrawLists/defaultIds').update({ participants: ids });
                await window.initializeAndDisplayDefaultIds();
                await window.refreshDistributionNicknameOptions();
                window.closeAddIdModal();
            } catch (e) {
                alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(e);
            }
        };

        // ì¶”ì²¨ í•¨ìˆ˜ (ì£¼í™©ìƒ‰, ìˆœì°¨ ì• ë‹ˆë©”ì´ì…˜, ê²°ê³¼ ê°•ì¡°)
        window.drawRandom = function() {
            const count = parseInt(document.getElementById('count').value, 10);
            const drawIdList = document.getElementById('drawIdList');
            const ids = Array.from(drawIdList.children).map(li => li.querySelector('span').textContent);
            const resultDiv = document.getElementById('result');

            if (ids.length === 0) {
                resultDiv.textContent = 'ë½‘ê¸° ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.';
                resultDiv.style = '';
                return;
            }
            if (isNaN(count) || count < 1 || count > ids.length) {
                resultDiv.textContent = 'ì˜¬ë°”ë¥¸ ì¸ì› ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                resultDiv.style = '';
                return;
            }

            // ì¶”ì²¨ ëŒ€ìƒ ì„ê¸°
            const shuffled = [...ids].sort(() => Math.random() - 0.5);
            const winners = shuffled.slice(0, count);
            resultDiv.className = 'text-accent text-center py-2 font-bold';

            // ì—¬ëŸ¬ ëª… ë½‘ì„ ë•Œ í•œ ëª…ì”© ìˆœì°¨ì ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜
            async function animateDraw(names, winnerList) {
                let resultHTML = '';
                for (let i = 0; i < winnerList.length; i++) {
                    await new Promise(resolve => {
                        let t = 0;
                        const duration = 900 + Math.random() * 600; // 0.9~1.5ì´ˆ
                        let lastName = '';
                        const interval = setInterval(() => {
                            lastName = names[Math.floor(Math.random() * names.length)];
                            resultDiv.innerHTML = resultHTML + `<span class='inline-block text-2xl md:text-3xl text-accent font-extrabold animate-pulse' style='color:#ff9800;'>${lastName}</span>`;
                        }, 50);
                        setTimeout(() => {
                            clearInterval(interval);
                            resultHTML += `<span class='block text-2xl md:text-3xl text-accent font-extrabold mb-1' style='color:#ff9800; animation:pop 0.5s;'>${winnerList[i]}</span>`;
                            resultDiv.innerHTML = resultHTML;
                            setTimeout(resolve, 350);
                        }, duration);
                    });
                }
                if (winnerList.length === 1) {
                    resultDiv.innerHTML = `ë‹¹ì²¨ì: <span class='text-accent font-extrabold text-2xl md:text-3xl' style='color:#ff9800; animation:pop 0.5s;'>${winnerList[0]}</span>`;
                } else {
                    resultDiv.innerHTML = `ë‹¹ì²¨ì:<br>` + winnerList.map(w => `<span class='block text-accent font-extrabold text-2xl md:text-3xl' style='color:#ff9800; animation:pop 0.5s;'>${w}</span>`).join('');
                }
            }
            animateDraw(ids, winners);
        };

        // ë½‘ê¸° ëŒ€ìƒ ëª©ë¡ì—ì„œ ì•„ì´ë”” ì œê±° í•¨ìˆ˜
        window.removeDrawId = function(btn) {
            btn.closest('li').remove();
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // ë‹‰ë„¤ì„ ë“œë¡­ë‹¤ìš´ì— ê¸°ë³¸ ì•„ì´ë”” ëª©ë¡ ì±„ìš°ê¸°
            await window.refreshDistributionNicknameOptions();
            // ì—”í„°í‚¤ë¡œë„ ì¶”ê°€
            document.getElementById('modalNewId').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    addNewIdFromModal();
                }
            });

            // ì´ˆê¸°í™” ì‹¤í–‰
            checkAdmin();
            await window.initializeAndDisplayDefaultIds();
            await loadDistributionInputs();
            document.getElementById('drawBtn').addEventListener('click', window.drawRandom);
        });
    </script>
</body>
</html>   
